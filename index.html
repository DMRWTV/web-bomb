const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

canvas.width = 240;
canvas.height = 240;

const GRID_COUNT = 11; 
const TILE = 240 / GRID_COUNT;

let player = { x: 1, y: 1, bombPower: 1 };
let bombs = [];
let explosions = [];

// 1 = Mur indestructible, 2 = Caisse destructible, 0 = Vide
const grid = [
    [1,1,1,1,1,1,1,1,1,1,1],
    [1,0,0,2,2,2,2,2,0,0,1],
    [1,0,1,2,1,2,1,2,1,0,1],
    [1,2,2,2,2,2,2,2,2,2,1],
    [1,2,1,2,1,2,1,2,1,2,1],
    [1,2,2,2,2,2,2,2,2,2,1],
    [1,0,1,2,1,2,1,2,1,0,1],
    [1,0,0,2,2,2,2,2,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1]
];

function placeBomb() {
    if (!bombs.find(b => b.x === player.x && b.y === player.y)) {
        let newBomb = { x: player.x, y: player.y, timer: 2000 }; // 2 secondes
        bombs.push(newBomb);
        
        // Déclencher l'explosion après le délai
        setTimeout(() => explode(newBomb), newBomb.timer);
    }
}

function explode(bomb) {
    // Supprimer la bombe
    bombs = bombs.filter(b => b !== bomb);
    
    // Créer l'onde de choc (Centre + 4 directions)
    const directions = [{x:0,y:0}, {x:1,y:0}, {x:-1,y:0}, {x:0,y:1}, {x:0,y:-1}];
    
    directions.forEach(dir => {
        let ex = bomb.x + dir.x;
        let ey = bomb.y + dir.y;
        
        if (grid[ey][ex] === 2) grid[ey][ex] = 0; // Détruire caisse
        if (grid[ey][ex] !== 1) {
            explosions.push({x: ex, y: ey, timer: 500}); // Afficher feu pendant 0.5s
        }
    });
}

function draw() {
    ctx.fillStyle = "#111";
    ctx.fillRect(0, 0, 240, 240);

    for(let y=0; y<grid.length; y++) {
        for(let x=0; x<grid[y].length; x++) {
            if(grid[y][x] === 1) ctx.fillStyle = "#333"; // Mur dur
            else if(grid[y][x] === 2) ctx.fillStyle = "#8d6e63"; // Caisse marron
            else continue;
            ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
        }
    }

    // Dessiner Explosions (Jaune/Orange)
    ctx.fillStyle = "#ffeb3b";
    explosions = explosions.filter(e => {
        ctx.fillRect(e.x*TILE, e.y*TILE, TILE, TILE);
        e.timer -= 16;
        return e.timer > 0;
    });

    // Dessiner Bombes (Blanc clignotant)
    ctx.fillStyle = (Math.floor(Date.now() / 200) % 2 === 0) ? "#fff" : "#ff4757";
    bombs.forEach(b => {
        ctx.beginPath();
        ctx.arc(b.x*TILE + TILE/2, b.y*TILE + TILE/2, TILE/3, 0, Math.PI*2);
        ctx.fill();
    });

    // Joueur
    ctx.fillStyle = "#00ffa3";
    ctx.fillRect(player.x*TILE + 4, player.y*TILE + 4, TILE-8, TILE-8);
}

function update() {
    const gp = navigator.getGamepads()[0];
    if (gp) {
        // Déplacement avec protection contre les caisses (grid !== 0)
        if (gp.buttons[12].pressed && grid[player.y-1][player.x] === 0) player.y--; 
        if (gp.buttons[13].pressed && grid[player.y+1][player.x] === 0) player.y++;
        if (gp.buttons[14].pressed && grid[player.y][player.x-1] === 0) player.x--;
        if (gp.buttons[15].pressed && grid[player.y][player.x+1] === 0) player.x++;
        
        if (gp.buttons[0].pressed) placeBomb(); // Bouton A
    }
    draw();
    setTimeout(() => requestAnimationFrame(update), 110);
}
update();
